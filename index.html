<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Checklists</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; background: #f0f2f5; color: #333; }
        h1 { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        
        /* Styly pro ovl√°dac√≠ prvky */
        .controls-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        select, input, .btn { width: 100%; padding: 12px; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; -webkit-appearance: none; }
        select { background: #fff url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3E%3Cpath fill='%23333' d='M2 0L0 2h4zm0 5L0 3h4z'/%3E%3C/svg%3E") no-repeat right .75rem center/8px 10px; }
        
        .btn { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; text-align: center; transition: background 0.2s; }
        .btn:active { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; color: #666; }
        .btn-stop { background: #dc3545; display: none; }
        
        /* Okno kamery */
        #reader { width: 100%; margin-bottom: 15px; border-radius: 12px; overflow: hidden; display: none; background: #000; }
        
        /* Karta s v√Ωsledky */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; animation: slideUp 0.3s ease-out; }
        .card h2 { margin-top: 0; color: #007bff; font-size: 1.3rem; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; margin-bottom: 15px; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .data-row:last-child { border-bottom: none; }
        .label-txt { font-weight: 600; color: #666; flex-shrink: 0; margin-right: 15px; }
        .value-txt { text-align: right; word-break: break-word; font-family: monospace; font-size: 1.1em; }
        .supplier-box { background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 0.9em; margin-top: 10px; }

        /* Chybov√° hl√°≈°ka */
        #error { background: #fff3f3; color: #dc3545; border: 1px solid #ffcdd2; text-align: center; padding: 15px; border-radius: 8px; display: none; font-weight: bold; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <h1>üîç Custom Checklists</h1>
    
    <div class="controls-container">
        <label for="storeSelect">1. Vyberte obchod (STORE):</label>
        <select id="storeSelect">
            <option value="">Naƒç√≠t√°m data...</option>
        </select>

        <label for="manualInput">2. Naskenujte nebo zadejte k√≥d:</label>
        <div id="reader"></div>
        <button id="startBtn" class="btn" onclick="startScan()" disabled>üì∑ Zapnout kameru</button>
        <button id="stopBtn" class="btn btn-stop" onclick="stopScan()">‚ùå Zastavit kameru</button>
        <input type="number" id="manualInput" placeholder="EAN / TPN / TPNB..." oninput="manualSearch(this.value)" disabled>
    </div>

    <div id="result" class="card">
        <h2 id="resDesc">N√°zev produktu</h2>
        <div class="data-row"><span class="label-txt">Obchod:</span> <span id="resStore" class="value-txt"></span></div>
        <div class="data-row"><span class="label-txt">EAN:</span> <span id="resEan" class="value-txt"></span></div>
        <div class="data-row"><span class="label-txt">TPN:</span> <span id="resTpn" class="value-txt"></span></div>
        <div class="data-row"><span class="label-txt">TPNB:</span> <span id="resTpnb" class="value-txt"></span></div>
        <div class="data-row"><span class="label-txt">DRG / Komment:</span> <span class="value-txt"><span id="resDrg"></span> / <span id="resKomment"></span></span></div>
        
        <div style="margin-top: 15px; font-weight: bold; color: #555;">Dodavatel:</div>
        <div class="supplier-box" id="resSupplier"></div>
    </div>

    <div id="error">
        ‚ùå K√≥d nenalezen ve vybran√©m obchodƒõ.
    </div>

    <script src="html5-qrcode.min.js"></script>
    <script src="papaparse.min.js"></script>

    <script>
        let inventoryData = [];
        let html5QrCode;
        const storeSelect = document.getElementById('storeSelect');
        const startBtn = document.getElementById('startBtn');
        const manualInput = document.getElementById('manualInput');
        // Zvuk pro √∫spƒõ≈°n√© naskenov√°n√≠ (voliteln√©)
        // const beep = new Audio('data:audio/wav;base64,UklGRl9vT1WAX1x... (zkr√°ceno)'); 

        // 1. Naƒçten√≠ dat p≈ôi startu
        Papa.parse("data.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                inventoryData = results.data;
                console.log("Data naƒçtena, ≈ô√°dk≈Ø:", inventoryData.length);
                populateStoreDropdown();
            },
            error: function(err) {
                alert("Chyba naƒç√≠t√°n√≠ data.csv: " + err);
            }
        });

        // 2. Naplnƒõn√≠ dropdown menu obchody
        function populateStoreDropdown() {
            // Z√≠sk√°me unik√°tn√≠ seznam obchod≈Ø ze sloupce 'STORE'
            const stores = [...new Set(inventoryData.map(item => item.STORE).filter(s => s))];
            // Se≈ôad√≠me je numericky nebo abecednƒõ
            stores.sort((a, b) => a - b);

            storeSelect.innerHTML = '<option value="">-- Vyberte obchod --</option>';
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = "Obchod " + store;
                storeSelect.appendChild(option);
            });
        }

        // Aktivace/deaktivace prvk≈Ø podle v√Ωbƒõru obchodu
        storeSelect.addEventListener('change', function() {
            const isSelected = this.value !== "";
            startBtn.disabled = !isSelected;
            manualInput.disabled = !isSelected;
            
            // Reset zobrazen√≠ p≈ôi zmƒõnƒõ obchodu
            document.getElementById('result').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            manualInput.value = '';
            if (!isSelected) stopScan();
        });


        // 3. Hlavn√≠ vyhled√°vac√≠ funkce
        function search(query) {
            const selectedStore = storeSelect.value;
            if (!selectedStore) {
                alert("Pros√≠m, nejprve vyberte obchod.");
                return;
            }

            const cleanedQuery = query.toString().trim();

            // HLAVN√ç LOGIKA: Filtruj podle obchodu A Z√ÅROVE≈á hledej v EAN, TPN nebo TPNB
            const item = inventoryData.find(row => {
                // Podm√≠nka 1: ≈ò√°dek mus√≠ pat≈ôit vybran√©mu obchodu
                const storeMatch = row.STORE == selectedStore;
                
                // Podm√≠nka 2: K√≥d se mus√≠ shodovat s jedn√≠m z tƒõchto sloupc≈Ø
                // Pou≈æ√≠v√°me voln√© porovn√°n√≠ (==) a trim() pro jistotu, ≈æe sed√≠ stringy i ƒç√≠sla
                const codeMatch = (row.EAN && row.EAN.trim() == cleanedQuery) ||
                                  (row.TPN && row.TPN.trim() == cleanedQuery) ||
                                  (row.TPNB && row.TPNB.trim() == cleanedQuery);

                return storeMatch && codeMatch;
            });
            
            if (item) {
                // if(beep) beep.play(); // P√≠pnut√≠
                showResult(item);
            } else {
                showError();
            }
        }

        // Zobrazen√≠ v√Ωsledku (napojen√≠ na va≈°i strukturu dat)
        function showResult(item) {
            document.getElementById('error').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            
            // Pozor: Sloupec v Excelu se jmenuje "Desc." (s teƒçkou), v JS mus√≠me pou≈æ√≠t z√°vorky ['Desc.']
            document.getElementById('resDesc').textContent = item['Desc.'] || "Bez n√°zvu";
            document.getElementById('resStore').textContent = item.STORE;
            document.getElementById('resEan').textContent = item.EAN || "-";
            document.getElementById('resTpn').textContent = item.TPN || "-";
            document.getElementById('resTpnb').textContent = item.TPNB || "-";
            document.getElementById('resDrg').textContent = item.DRG || "";
            document.getElementById('resKomment').textContent = item.KOMMENT || "";
            document.getElementById('resSupplier').textContent = item.Supplier || "";
        }

        function showError() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        function manualSearch(val) {
            if(val.length >= 3) search(val);
        }

        // --- Funkce pro kameru (z≈Øst√°vaj√≠ stejn√©) ---
        function startScan() {
            document.getElementById('reader').style.display = 'block';
            startBtn.style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            html5QrCode = new Html5Qrcode("reader");
            // Zkus√≠me pou≈æ√≠t zadn√≠ kameru, preferujeme environment
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, defineReaderConfig: { cameraSupportsTorch: true } };
            
            html5QrCode.start({ facingMode: "environment" }, config,
                (decodedText) => {
                    stopScan();
                    manualInput.value = decodedText;
                    search(decodedText);
                },
                () => {} // Ignorujeme chyby p≈ôi bƒõhu skenov√°n√≠
            ).catch(err => {
                alert("Chyba kamery: Ujistƒõte se, ≈æe jste na HTTPS a povolili jste p≈ô√≠stup.");
                stopScan();
            });
        }

        function stopScan() {
            if(html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    resetCameraUI();
                    html5QrCode.clear();
                }).catch(() => resetCameraUI());
            } else {
                resetCameraUI();
            }
        }

        function resetCameraUI() {
            document.getElementById('reader').style.display = 'none';
            startBtn.style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
        }

        // Registrace SW pro offline re≈æim
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
        }
    </script>
</body>
</html>
